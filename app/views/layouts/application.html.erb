<!-- app/views/layouts/application.html.erb -->
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <title><%= content_for(:title) || "Game" %></title>
    <%= csrf_meta_tags %>
    <%= csp_meta_tag %>

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css">

    <!-- Google Font -->
    <link href="https://fonts.googleapis.com/css2?family=Bangers&display=swap" rel="stylesheet">

    <style>
      /* Lock the viewport and prevent scrollbars */
      html, body {
        margin: 0;
        padding: 0;
        width: 100%;
        height: 100vh;
        overflow: hidden;
      }

      /* Global background gradient */
      body {
        background: linear-gradient(to bottom, #000000, #0a1a3c, #004080, #0091ff);
      }

      /* Starfield container */
      #stars {
        position: absolute;
        top: 55px;
        left: 0;
        width: 100%;
        height: calc(100% - 55px);
        pointer-events: none;
        z-index: 0;
      }

      /* Individual star appearance */
      .star {
        position: absolute;
        width: 2px;
        height: 2px;
        background: #ffffff;
        border-radius: 50%;
        animation: twinkle 2s infinite alternate;
      }

      @keyframes twinkle {
        from { opacity: 0.25; }
        to   { opacity: 1; }
      }

      /* Page content sits above stars */
      main.content {
        position: relative;
        z-index: 1;
      }
    </style>

    <%= yield :head %>
  </head>

  <body>
    <!-- Global site header -->
    <%= render "home/header" %>

    <!-- Starfield background -->
    <div id="stars"></div>

    <!-- Main content area -->
    <main class="container content">
      <br/>
      <%= yield %>
    </main>

    <!-- Audio elements -->
    <audio id="click-sound" src="<%= asset_path('mouse_click.mp3') %>"></audio>
    <audio id="win-sound" src="<%= asset_path('Winning_an_extra_bonus.wav') %>"></audio>

    <!-- jQuery + Bootstrap bundle -->
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js"></script>

    <%= javascript_importmap_tags %>

    <script>
      // Build the starfield
      function initStars() {
        const container = document.getElementById('stars');
        if (!container) return;

        const starCount = 2000;
        const maxWidth = document.documentElement.clientWidth;
        const maxHeight = window.innerHeight - 55;

        container.innerHTML = '';

        for (let i = 0; i < starCount; i++) {
          const star = document.createElement('div');
          star.className = 'star';
          star.style.left = Math.random() * maxWidth + 'px';
          star.style.top = Math.random() * maxHeight + 'px';
          star.style.animationDelay = (Math.random() * 5).toFixed(2) + 's';
          container.appendChild(star);
        }
      }

      document.addEventListener('DOMContentLoaded', initStars);
      document.addEventListener('turbo:load', initStars);
      window.addEventListener('resize', initStars);

      // Attach click sound to all buttons
      function attachButtonSounds() {
        const audio = document.getElementById('click-sound');
        if (!audio) return;

        document.querySelectorAll('button, input[type="submit"]').forEach(el => {
          el.addEventListener('click', () => {
            audio.currentTime = 0;
            audio.play().catch(() => {});
          });
        });
      }

      document.addEventListener('DOMContentLoaded', attachButtonSounds);
      document.addEventListener('turbo:load', attachButtonSounds);

      // Play win sound if notice contains "Correct!"
      document.addEventListener('turbo:load', () => {
        const notice = document.querySelector('[style*="lightgreen"]');
        const winAudio = document.getElementById('win-sound');
        if (notice && notice.textContent.includes("Correct!")) {
          winAudio.currentTime = 0;
          winAudio.play().catch(() => {});
        }
      });
    </script>
  </body>
</html>
